<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laze RS</title>
    <link rel="stylesheet" href="/css/hack.css">
    <link rel="stylesheet" href="/css/site.css">
    <link rel="stylesheet" href="/css/highlight.css">
  </head>
  <body class="hack">
    <div class="container">

<pre class="sourceCode rust"><code class="sourceCode rust"><span class="kw">use</span> serde;
<span class="kw">use</span> serde::de::Deserialize;

<span class="ot">#[</span>derive<span class="ot">(</span>Debug<span class="ot">)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> DocumentCreated {
    <span class="kw">pub</span> ok: <span class="kw">bool</span>,
    <span class="kw">pub</span> id: String,
    <span class="kw">pub</span> rev: String,
}

<span class="kw">enum</span> DocumentCreatedField {
    <span class="kw">Ok</span>,
    Id,
    Rev,
}

<span class="kw">impl</span> Deserialize <span class="kw">for</span> DocumentCreated {
    <span class="kw">fn</span> deserialize&lt;D&gt;(deserializer: &amp;<span class="kw">mut</span> D) -&gt; <span class="kw">Result</span>&lt;DocumentCreated, D::Error&gt;
        where D: serde::Deserializer
    {
        deserializer.deserialize(DocumentCreatedVisitor)
    }
}

<span class="kw">impl</span> serde::Deserialize <span class="kw">for</span> DocumentCreatedField {
    <span class="kw">fn</span> deserialize&lt;D&gt;(deserializer: &amp;<span class="kw">mut</span> D) -&gt; <span class="kw">Result</span>&lt;DocumentCreatedField, D::Error&gt;
        where D: serde::de::Deserializer
    {
        <span class="kw">struct</span> DocumentCreatedFieldVisitor;

        <span class="kw">impl</span> serde::de::Visitor <span class="kw">for</span> DocumentCreatedFieldVisitor {
            <span class="kw">type</span> Value = DocumentCreatedField;

            <span class="kw">fn</span> visit_str&lt;E&gt;(&amp;<span class="kw">mut</span> <span class="kw">self</span>, value: &amp;<span class="kw">str</span>) -&gt; <span class="kw">Result</span>&lt;DocumentCreatedField, E&gt;
                where E: serde::de::Error
            {
                <span class="kw">match</span> value {
                    <span class="st">&quot;ok&quot;</span> =&gt; <span class="kw">Ok</span>(DocumentCreatedField::<span class="kw">Ok</span>),
                    <span class="st">&quot;id&quot;</span> =&gt; <span class="kw">Ok</span>(DocumentCreatedField::Id),
                    <span class="st">&quot;rev&quot;</span> =&gt; <span class="kw">Ok</span>(DocumentCreatedField::Rev),
                    _ =&gt; {
                        <span class="kw">Err</span>(serde::de::Error::unknown_field(<span class="ot">format!</span>(<span class="st">&quot;expected ok, id or rev \</span>
<span class="st">                                                                     field, got: {}&quot;</span>,
                                                                    value)
                            .as_ref()))
                    }
                }
            }
        }

        deserializer.deserialize(DocumentCreatedFieldVisitor)
    }
}

<span class="kw">struct</span> DocumentCreatedVisitor;

<span class="kw">impl</span> serde::de::Visitor <span class="kw">for</span> DocumentCreatedVisitor {
    <span class="kw">type</span> Value = DocumentCreated;

    <span class="kw">fn</span> visit_map&lt;V&gt;(&amp;<span class="kw">mut</span> <span class="kw">self</span>, <span class="kw">mut</span> visitor: V) -&gt; <span class="kw">Result</span>&lt;DocumentCreated, V::Error&gt;
        where V: serde::de::MapVisitor
    {
        <span class="kw">let</span> <span class="kw">mut</span> ok = <span class="kw">None</span>;
        <span class="kw">let</span> <span class="kw">mut</span> id = <span class="kw">None</span>;
        <span class="kw">let</span> <span class="kw">mut</span> rev = <span class="kw">None</span>;

        <span class="kw">loop</span> {
            <span class="kw">match</span> <span class="ot">try!</span>(visitor.visit_key()) {
                <span class="kw">Some</span>(DocumentCreatedField::<span class="kw">Ok</span>) =&gt; {
                    ok = <span class="kw">Some</span>(<span class="ot">try!</span>(visitor.visit_value()));
                }
                <span class="kw">Some</span>(DocumentCreatedField::Id) =&gt; {
                    id = <span class="kw">Some</span>(<span class="ot">try!</span>(visitor.visit_value()));
                }
                <span class="kw">Some</span>(DocumentCreatedField::Rev) =&gt; {
                    rev = <span class="kw">Some</span>(<span class="ot">try!</span>(visitor.visit_value()));
                }
                <span class="kw">None</span> =&gt; {
                    <span class="kw">break</span>;
                }
            }
        }

        <span class="kw">let</span> ok = <span class="kw">match</span> ok {
            <span class="kw">Some</span>(ok) =&gt; ok,
            <span class="kw">None</span> =&gt; <span class="ot">try!</span>(visitor.missing_field(<span class="st">&quot;ok&quot;</span>)),
        };

        <span class="kw">let</span> id = <span class="kw">match</span> id {
            <span class="kw">Some</span>(id) =&gt; id,
            <span class="kw">None</span> =&gt; <span class="ot">try!</span>(visitor.missing_field(<span class="st">&quot;seq&quot;</span>)),
        };

        <span class="kw">let</span> rev = <span class="kw">match</span> rev {
            <span class="kw">Some</span>(rev) =&gt; rev,
            <span class="kw">None</span> =&gt; <span class="ot">try!</span>(visitor.missing_field(<span class="st">&quot;rev&quot;</span>)),
        };

        <span class="ot">try!</span>(visitor.end());

        <span class="kw">Ok</span>(DocumentCreated {
            ok: ok,
            id: id,
            rev: rev,
        })
    }
}

<span class="ot">#[</span>cfg<span class="ot">(</span>test<span class="ot">)]</span>
<span class="kw">mod</span> tests {
    <span class="kw">use</span> serde_json <span class="kw">as</span> json;
    <span class="kw">use</span> <span class="kw">super</span>::DocumentCreated;

    <span class="ot">#[</span>test<span class="ot">]</span>
    <span class="kw">fn</span> parses_document_created() {
        json::from_str::&lt;DocumentCreated&gt;(<span class="st">&quot;{</span><span class="ch">\&quot;</span><span class="st">ok</span><span class="ch">\&quot;</span><span class="st">: true, </span><span class="ch">\&quot;</span><span class="st">id</span><span class="ch">\&quot;</span><span class="st">: </span><span class="ch">\&quot;</span><span class="st">213123</span><span class="ch">\&quot;</span><span class="st">, </span><span class="ch">\&quot;</span><span class="st">rev</span><span class="ch">\&quot;</span><span class="st">: \</span>
<span class="st">                                           </span><span class="ch">\&quot;</span><span class="st">1-cd90201763f897aa0178b7ff05eb80cb</span><span class="ch">\&quot;</span><span class="st">}&quot;</span>)
            .unwrap();
    }
}</code></pre>

      <a href="/">top<a/>
    </div>
  </body>
  <script src="./prism.js"></script>
</html>
